% Test case to find the probability that Z >= t where Z is standard normal.
% P_p(Z >= t) = P_p(f^{(L)}(Z) >= t)

N = 1e4;
m = 1.6;
s = 0.25;
Z = exp(m + s*randn(N,1));

L = 10; % High-fidelity.

p = @(x) 1/sqrt(2*pi) * exp(-0.5*x.^2);
f = @(x, l) x + (exp(-l) - exp(-L));


p = @(x) normpdf(log(x), 1.6, 0.25)./x;

lvl = 1:L;
t = 2;
rho = 0.9;
dt = 0.01;

g = @(x) f(x, 10);

[prob, mu, S] = CE_LogNormal(Z, t, p, g, N, rho, dt, {});

fprintf("\nMFCE Estimate    = %f\n",prob);

prob_true = 1 - normcdf(log(t));
fprintf("True Probability = %f\n", prob_true);

relerr = abs(prob_true - prob)/prob_true;
fprintf("Relative Error   = %f\n\n", relerr);

figure(1);
x = linspace(0.5, 8, 250);
pdf = normpdf(log(x), 1.6, .25)./x;
plot(x, pdf, 'b-');
hold on
bias = normpdf(log(x), mu, sqrt(S))./x;
plot(x, bias, 'r-');
legend(["Target", "Biasing"], 'interpreter', 'latex', 'Location', 'NorthWest');
xlabel('$x$', 'interpreter', 'latex');
ylabel('Density', 'interpreter', 'latex');
title('MFCE Biasing Density', 'interpreter', 'latex');